---
Title: Twitter APIを使って検索取得したJSONをGoogle App Engineに保存するcron
Category:
- Python
- AppEngine
Date: 2010-07-23T00:00:00+09:00
URL: https://yoshiyoshifujii.hatenablog.com/entry/20100723/p1
EditURL: https://blog.hatena.ne.jp/yoshiyoshifujii/yoshiyoshifujii.hatenablog.com/atom/entry/11696248318757243130
---


Twitter APIを使って、あるキーワードで取得した結果を、そのままGoogle App EngineのEntityに保存する。

というcronを作ったので、メモっておく。

app.yamlは以下のようにする。

>|yaml|
application: hoge
version: 1
runtime: python
api_version: 1

- url: /c/.*
  script: cron/urls.py
  login: admin
||<

cron.yamlは以下のようにする。

>|yaml|
cron:
- description: 10 minutes job
  url: /cron/pull/
  schedule: every 10 minutes
||<

cron/urls.pyに以下のように記述する。

>|python|
from google.appengine.ext import webapp
from google.appengine.ext.webapp.util import run_wsgi_app

import utils

from cron.views import PullAction

application = webapp.WSGIApplication(
    utils.patterns(
        ('/c/pull/', PullAction),
        ), debug=True)

if __name__ == "__main__":
    run_wsgi_app(application)
||<

cron/views.pyは、以下のようにする。refresh_urlが取得できたら、refresh_urlをGETパラメータに指定して取得する。

>|python|
import urllib, urllib2

from google.appengine.api import users
from google.appengine.ext import webapp, db

from django.utils import simplejson

from utils import render_to_response

from tweets.models import Twitter

class PullAction(webapp.RequestHandler):
    def get(self):

        baseurl = "http://search.twitter.com/search.json"

        t_l = Twitter.all().order("-insert_date")
        if t_l:
            json = simplejson.loads(t_l[0].src)
            q = json["refresh_url"]
        else:
            q = "?%s" % urllib.urlencode({"q": "#childquest"})

        src = urllib2.urlopen(baseurl + q)
        Twitter(src=src.read()).put()
||<

保存するEntityは、tweets/models.pyに以下のように書く。

>|python|
# -*- coding: utf-8 -*-

from google.appengine.ext import db
from google.appengine.ext.db import polymodel

class Twitter(db.Model):
    insert_date = db.DateTimeProperty("登録日時", auto_now_add=True)
    src = db.BlobProperty()
||<

とりあえず、これでそのまんま保存できる。
