---
Title: 我が子をインターネットの誘惑から守るためにProxy Serverを建てた
Category:
- squid
Date: 2017-03-14T23:47:34+09:00
URL: https://yoshiyoshifujii.hatenablog.com/entry/2017/03/14/234734
EditURL: https://blog.hatena.ne.jp/yoshiyoshifujii/yoshiyoshifujii.hatenablog.com/atom/entry/10328749687227032214
---

最近の子はすごいですね。

子供に要らなくなったiPhone4を使っていいよってことで、渡しているのですが、悪いこと?ができないよーにと、年齢制限とか良い感じにロックしてたのです。

が、久しぶりに見てみると、パスワードを推測して、解除し、自分でロックして親がアクセスできなくしちゃうんですね。

そーなってくると、親もついついカっとなって、Proxy Server建てちゃいますよね。

ってことで、たてたので、その手順をメモ。



<!-- more -->



# AWS EC2上にsquidを構築する

個人的にEC2を運用していたので、そいつを、proxy serverにして、EC2を経由してインターネットするよーにしてみようと思う。

LAN内にRaspberry PiとかでProxy Serverにするでも良いのだが、LANで頑張るのもちょっと時間かかるので、私にとって、お手軽な道を選んだ。

環境は、

* Amazon EC2
* Ubuntu 14.04 LTS

です。

まずは、インストール。

```sh
$ sudo apt-get install squid
```

それから、設定を変更。

```sh
sudo vim /etc/squid3/squid.conf
```

以下の2箇所をコメントアウトして、

```conf
#http_access deny all
...
#http_port 3128
```

以下の設定を最下部に追記した。

```conf
http_port xxxxx # デフォだと危険だし、任意の良い感じの数値にした。
acl myacl src all # allにするのは、EC2のSecurity GroupでFROMのGIPを制限するからいっかって感じ。
http_access allow myacl
http_access deny all
forwarded_for off
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access Cache-Control deny all
logfile_rotate 7
```

# AWS EC2 のSecurity GroupでGIPを制限する

iptablesとかでやるのが通常なのかと思いますが、Security Groupだけで制限しました。

設定方法は割愛しますが、squidに設定したポート番号を自分とこのGIPからアクセスを許可するよーにして、他は閉じてる感じです。

# ホームルーターのIPフィルターを設定

このあたりは、ご使用になられているホームルーターによって設定方法とか違うと思います。

うちは、BUFFALOのAirStationなるルーターを使っているので、IPフィルターを設定しました。

| 操作 | 方向 | 送信元アドレス | 宛先アドレス | プロトコル |
|------|------|----------------|--------------|------------|
| 無視 | LAN →インターネット | 全て | 全て | HTTPS |
| 無視 | LAN →インターネット | 全て | 全て | HTTP |

みたいな感じで、HTTPとHTTPSを制限するようにしました。

それ以外は基本OKにしています。

ので、けっこー緩い監視にしよーって思ってます。まずは。

いきなり全ポート閉じると、自分が面倒なので。

# ブラウザのプロキシ設定を有効にする

このあたりは、WinとかMacとかブラウザの種類とかでいろいろ設定方法異なると思いますが、だいたいは、

Proxy ServerのGIPと設定したポート番号

を入力してやることで、インターネットのほとんど80と443ポートを使うよーなアクセスについては、Squidを経由してアクセスするようにできました。

# 監視

まーなんか、あやしい行動してたら、ログで確認しよっかな程度で考えてます。

そのうち、あかんサイトとかを設定してフィルタするかどーしよっかなって考えてますが、まあいまはいっかって思ってます。

以上です。
